{% extends 'base.html' %}

{% block title %}User Management - OpenTracker{% endblock %}

{% block content %}
<div class="management-container">
    <div class="page-header">
        <div class="page-title">
            <h1>User Management</h1>
            <p>Manage all users in the system</p>
        </div>
        <div class="page-actions">
            <div class="users-stats">
                <h3>Overview</h3>
                <div class="stat-cards-header">
                    <div class="stat-card-header">
                        <span class="stat-number">{{ page_obj|length }}</span>
                        <span class="stat-label">{% if search_query %}Found{% else %}Showing{% endif %}</span>
                    </div>
                    <div class="stat-card-header">
                        <span class="stat-number">{{ total_users }}</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-card-header pending">
                        <span class="stat-number">{{ registration_requests.count|default:0 }}</span>
                        <span class="stat-label">Pending</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <div class="users-content">
        <div class="users-main">
                {% if registration_requests %}
    <!-- Registration Requests Section -->
    <div class="section-container">
        <div class="section-header">
            <h2>Pending Registration Requests</h2>
            <span class="section-badge">{{ registration_requests.count }} pending</span>
        </div>
        
        <div class="table-container">

        <div class="table-wrapper">
            <table class="data-table registration-table">
                <thead>
                    <tr>
                        <th class="user-col">User</th>
                        <th class="email-col">Email</th>
                        <th class="group-col">Requested Group</th>
                        <th class="date-col">Registered</th>
                        <th class="actions-col-wide">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in registration_requests %}
                    <tr>
                        <td>
                            <div class="user-info">
                                <span class="username">{{ request.user.username }}</span>
                                <span class="status-badge pending">Pending</span>
                            </div>
                        </td>
                        <td>{{ request.user.email|default:"-" }}</td>
                        <td>{{ request.requested_group_info|default:"None specified" }}</td>
                        <td>{{ request.created_at|date:"M d, Y H:i" }}</td>
                        <td class="actions-cell">
                            <form method="post" class="d-inline" id="approve-form-{{ request.id }}">
                                {% csrf_token %}
                                <input type="hidden" name="request_id" value="{{ request.id }}">
                                <input type="hidden" name="action" value="approve">
                                
                                <div class="approval-controls">
                                    <select name="group_id" class="form-select-sm" required>
                                        <option value="">Select Group</option>
                                        {% for group in groups %}
                                        <option value="{{ group.id }}" {% if group.name == request.requested_group_info %}selected{% endif %}>
                                            {{ group.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    
                                    <select name="role" class="form-select-sm">
                                        <option value="member">Member</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                    
                                    <button type="submit" class="btn-approve">Approve</button>
                                    <button type="button" class="btn-reject" onclick="rejectRequest('{{ request.id }}')">Reject</button>
                                </div>
                            </form>
                            
                            <!-- Hidden reject form -->
                            <form method="post" class="d-none" id="reject-form-{{ request.id }}">
                                {% csrf_token %}
                                <input type="hidden" name="request_id" value="{{ request.id }}">
                                <input type="hidden" name="action" value="reject">
                                <input type="hidden" name="notes" value="">
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="no-users">No pending registration requests.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    </div>
    {% endif %}

    <!-- Users Section -->
    <div class="section-container">
        <div class="section-header">
            <h2>Users</h2>
            <span class="section-badge">{{ total_users }} total</span>
        </div>
        
        <div class="main-search-section">
            <form method="get" class="main-search-form">
                <div class="main-search-input-group">
                    <div>
                        <input type="text" 
                               name="search" 
                               placeholder="Search users..." 
                               value="{{ search_query }}" 
                               class="main-search-input">
                        <button type="submit" class="btn-main-search">Search</button>
                        {% if search_query %}
                            <a href="?per_page={{ per_page }}" class="btn-main-clear">Clear</a>
                        {% endif %}
                    </div>
                    <a href="{% url 'accounts:create_user' %}" class="btn-add-user">Create New User</a>
                </div>
                {% if search_query %}
                    <p class="main-search-info">Searching for "{{ search_query }}"</p>
                {% endif %}
            </form>
        </div>
        
        <div class="table-container">
            <div class="table-header">
        <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in page_obj %}
                <tr>
                    <td class="username-cell">
                        {{ user.username }}
                        {% if user == request.user %}
                            <span class="current-user-badge">You</span>
                        {% endif %}
                    </td>
                    <td>{{ user.email|default:"-" }}</td>
                    <td>
                        {% if user.is_superuser %}
                            <span class="status-badge superuser">Super Admin</span>
                        {% elif user.is_staff %}
                            <span class="status-badge staff">Staff</span>
                        {% else %}
                            <span class="status-badge user">User</span>
                        {% endif %}
                    </td>
                    <td>{{ user.date_joined|date:"M d, Y" }}</td>
                    <td>{{ user.last_login|date:"M d, Y"|default:"Never" }}</td>
                    <td class="actions-cell">
                        <a href="{% url 'accounts:edit_user' user.id %}" class="btn-update">Edit</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="no-users">No users found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        </div>
    </div>
    
    <div class="pagination-container">
        <div class="pagination-size-control">
            <form method="get" class="pagination-size-form">
                {% if search_query %}
                    <input type="hidden" name="search" value="{{ search_query }}">
                {% endif %}
                <span class="page-info-text">Show:</span>
                <select name="per_page" id="per_page_bottom" class="pagination-size-select" onchange="this.form.submit()">
                    <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                </select>
                <span class="page-info-text">per page</span>
            </form>
        </div>
        
        {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}" class="page-link">First</a>
                <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}" class="page-link">Previous</a>
            {% endif %}
            
            <span class="page-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }} ({{ page_obj.paginator.count }} total users)</span>
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}" class="page-link">Next</a>
                <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}" class="page-link">Last</a>
            {% endif %}
        </div>
        {% else %}
        <div class="pagination">
            <span class="page-info">({{ page_obj.paginator.count }} total users)</span>
        </div>
        {% endif %}
    </div>
    
        </div>
    </div>
    
    <div class="management-footer">
        <a href="{% url 'myapp:index' %}" class="btn-secondary">Back to Home</a>
    </div>
</div>

<script>
function rejectRequest(requestId) {
    if (confirm('Are you sure you want to reject this registration request?')) {
        document.getElementById('reject-form-' + requestId).submit();
    }
}

// Instant search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('userSearch');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchValue = this.value.trim();
                const currentUrl = new URL(window.location);
                
                if (searchValue) {
                    currentUrl.searchParams.set('search', searchValue);
                } else {
                    currentUrl.searchParams.delete('search');
                }
                
                currentUrl.searchParams.delete('page'); // Reset to first page
                window.location.href = currentUrl.toString();
            }, 500); // 500ms delay for better UX
        });
    }
});
</script>

<style>
    .page-header {
        background: white;
        border-radius: 10px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 24px;
    }
    
    .page-title h1 {
        margin: 0 0 8px 0;
        color: #1a73e8;
        font-size: 28px;
        font-weight: 400;
    }
    
    .page-title p {
        margin: 0;
        color: #5f6368;
        font-size: 14px;
    }
    
    .page-actions {
        display: flex;
        gap: 16px;
        align-items: center;
    }
    
    .users-content {
        display: block;
        min-height: 600px;
    }
    
    .stat-cards-header {
        display: flex;
        gap: 20px;
    }
    
    .stat-card-header {
        background: #f8f9fa;
        padding: 12px 16px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #1a73e8;
        min-width: 80px;
    }
    
    .stat-card-header .stat-number {
        display: block;
        font-size: 20px;
        font-weight: 600;
        color: #1a73e8;
        line-height: 1;
    }
    
    .stat-card-header .stat-label {
        display: block;
        font-size: 11px;
        color: #5f6368;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 4px;
    }
    
    .users-stats h3 {
        margin: 0 0 16px 0;
        color: #1a73e8;
        font-size: 18px;
        font-weight: 500;
    }
    
    .users-main {
        background: white;
        border-radius: 10px;
        padding: 24px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .main-search-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 24px;
        border-left: 4px solid #1a73e8;
    }
    
    .main-search-input-group {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    
    .main-search-input-group > div:first-child {
        display: flex;
        gap: 12px;
        align-items: center;
        flex: 1;
    }
    
    .main-search-input {
        flex: 1;
        min-width: 300px;
        padding: 12px 16px;
        border: 2px solid #e8eaed;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.2s ease;
    }
    
    .main-search-input:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }
    
    .btn-main-search {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .btn-main-search:hover {
        background: #1557b0;
    }
    
    .btn-main-clear {
        display: inline-block;
        background: #f1f3f4;
        color: #5f6368;
        text-decoration: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s ease;
    }
    
    .btn-main-clear:hover {
        background: #e8eaed;
    }
    
    .btn-add-user {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: inline-block;
    }
    
    .btn-add-user:hover {
        background: #1557b0;
        color: white;
        text-decoration: none;
    }
    
    .main-search-info {
        margin: 12px 0 0 0;
        padding: 8px 12px;
        background: #e3f2fd;
        border-radius: 6px;
        font-size: 14px;
        color: #1565c0;
    }
    
    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: stretch;
            gap: 16px;
        }
        
        .page-actions {
            justify-content: center;
        }
        
        .stat-cards-header {
            flex-direction: column;
            gap: 12px;
        }
        
        .stat-card-header {
            min-width: auto;
        }
        
        .main-search-input {
            min-width: 200px;
        }
        
        .main-search-input-group {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }
        
        .main-search-input-group > div:first-child {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .btn-main-search,
        .btn-main-clear,
        .btn-add-user {
            width: 100%;
        }
    }

.btn-update {
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.btn-update:hover {
    background: #1557b0;
    color: white;
    text-decoration: none;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(26, 115, 232, 0.3);
}

.btn-update:before {
    content: "✏️";
    font-size: 12px;
}

/* Registration Request Styles */
.status-badge.pending {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.approval-controls {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: nowrap;
    min-width: 280px;
}

.form-select-sm {
    padding: 3px 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 11px;
    min-width: 85px;
    max-width: 90px;
}

.btn-approve, .btn-reject {
    padding: 3px 8px;
    border: none;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.btn-approve {
    background: #28a745;
    color: white;
}

.btn-approve:hover {
    background: #218838;
    transform: translateY(-1px);
}

.btn-reject {
    background: #dc3545;
    color: white;
}

.btn-reject:hover {
    background: #c82333;
    transform: translateY(-1px);
}

.current-user-badge {
    background: #e8f5e8;
    color: #137333;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    margin-left: 8px;
}

/* Section Styles */
.section-container {
    background: white;
    border-radius: 10px;
    padding: 24px;
    margin-bottom: 32px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #f5f5f5;
}

.section-header h2 {
    margin: 0;
    color: #1a1a1a;
    font-size: 24px;
    font-weight: 600;
}

.section-badge {
    background: #e3f2fd;
    color: #1976d2;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
}

/* Pending requests styling */
.stat-card-header.pending {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-left: 4px solid #f39c12;
    border-radius: 8px;
    padding: 8px 12px;
}

.stat-card-header.pending .stat-number {
    color: #856404;
}

.stat-card-header.pending .stat-label {
    color: #856404;
}

/* Registration Table Column Widths */
.registration-table .user-col {
    width: 15%;
    min-width: 120px;
}

.registration-table .email-col {
    width: 20%;
    min-width: 150px;
}

.registration-table .name-col {
    width: 15%;
    min-width: 120px;
}

.registration-table .group-col {
    width: 15%;
    min-width: 120px;
}

.registration-table .date-col {
    width: 12%;
    min-width: 100px;
}

.registration-table .actions-col-wide {
    width: 23%;
    min-width: 280px;
    white-space: nowrap;
}

.actions-cell {
    white-space: nowrap;
}

/* Registration Table Column Widths */
.registration-table .user-col {
    width: 15%;
    min-width: 120px;
}

.registration-table .email-col {
    width: 20%;
    min-width: 150px;
}

.registration-table .name-col {
    width: 15%;
    min-width: 120px;
}

.registration-table .group-col {
    width: 15%;
    min-width: 120px;
}

.registration-table .date-col {
    width: 12%;
    min-width: 100px;
}

.registration-table .actions-col-wide {
    width: 23%;
    min-width: 280px;
    white-space: nowrap;
}

.actions-cell {
    white-space: nowrap;
}

@media (max-width: 768px) {
    .table-container {
        margin: 0 -10px;
    }
    
    .data-table {
        font-size: 12px;
    }
    
    .data-table th,
    .data-table td {
        padding: 8px 4px;
    }
    
    .actions-cell {
        min-width: 120px;
    }
    
    .btn-update {
        padding: 4px 8px;
        font-size: 11px;
    }
    
    .approval-controls {
        flex-direction: column;
        gap: 3px;
        align-items: stretch;
        min-width: auto;
    }
    
    .form-select-sm {
        min-width: 70px;
        max-width: none;
        font-size: 10px;
    }
    
    .btn-approve, .btn-reject {
        font-size: 10px;
        padding: 2px 6px;
    }
    
    .section-container {
        padding: 16px;
        margin-bottom: 24px;
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .section-header h2 {
        font-size: 20px;
    }
    
    .registration-table .user-col,
    .registration-table .email-col,
    .registration-table .group-col,
    .registration-table .date-col {
        min-width: 80px;
    }
    
    .registration-table .actions-col-wide {
        min-width: 200px;
    }
    
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding: 15px 0;
        border-top: 1px solid #e9ecef;
    }
    
    .pagination {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .page-info-container {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .pagination-size-control {
        display: flex;
        align-items: center;
    }
    
    .pagination-size-form {
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 0;
    }
    
    .page-info-text {
        font-size: 14px;
        color: #666;
        margin: 0;
    }
    
    .page-info-separator {
        font-size: 14px;
        color: #666;
        margin: 0 4px;
    }
    
    .pagination-size-select {
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
        font-size: 14px;
        color: #666;
        cursor: pointer;
        min-width: 50px;
        margin: 0 2px;
    }
    
    .pagination-size-select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    
    @media (max-width: 768px) {
        .pagination-container {
            justify-content: center;
        }
        
        .pagination {
            flex-direction: column;
            gap: 15px;
        }
        
        .page-info-container {
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }
        
        .page-info-separator {
            display: none;
        }
    }
}
</style>

<script>
function rejectRequest(requestId) {
    if (confirm('Are you sure you want to reject this registration request?')) {
        document.getElementById('reject-form-' + requestId).submit();
    }
}

// Instant search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('userSearch');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchValue = this.value.trim();
                const currentUrl = new URL(window.location);
                
                if (searchValue) {
                    currentUrl.searchParams.set('search', searchValue);
                } else {
                    currentUrl.searchParams.delete('search');
                }
                
                currentUrl.searchParams.delete('page'); // Reset to first page
                window.location.href = currentUrl.toString();
            }, 500); // 500ms delay for better UX
        });
    }
});
</script>

{% endblock %}