{% extends 'base.html' %}

{% block title %}Admin Dashboard - OpenTracker{% endblock %}

{% block content %}
<div class="admin-dashboard-container">
    <!-- Dashboard Header -->
    <div class="admin-header">
        <div class="header-content">
            <h1 class="admin-title">
                <i class="admin-icon">‚öôÔ∏è</i>
                Admin Dashboard
            </h1>
            <p class="admin-subtitle">System overview and data management</p>
        </div>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card" data-stat="devices">
            <div class="stat-icon">üì±</div>
            <div class="stat-content">
                <div class="stat-number">{{ admin_stats.total_devices }}</div>
                <div class="stat-label">Total Devices</div>
            </div>
        </div>
        
        <div class="stat-card" data-stat="groups">
            <div class="stat-icon">üë•</div>
            <div class="stat-content">
                <div class="stat-number">{{ admin_stats.total_groups }}</div>
                <div class="stat-label">Groups</div>
            </div>
        </div>
        
        <div class="stat-card" data-stat="users">
            <div class="stat-icon">üë§</div>
            <div class="stat-content">
                <div class="stat-number">{{ admin_stats.total_users }}</div>
                <div class="stat-label">Users</div>
            </div>
        </div>
        
        <div class="stat-card data-stat" data-stat="data-entries">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <div class="stat-number">{{ admin_stats.total_data_entries|floatformat:0 }}</div>
                <div class="stat-label">Data Entries</div>
                <div class="stat-sub">~{{ admin_stats.estimated_db_size|filesizeformat }}</div>
            </div>
        </div>
        
        <div class="stat-card recent-data" data-stat="recent-entries">
            <div class="stat-icon">üïê</div>
            <div class="stat-content">
                <div class="stat-number">{{ admin_stats.recent_data_count }}</div>
                <div class="stat-label">Last 24 Hours</div>
            </div>
        </div>
    </div>

    <!-- Data Management Section -->
    <div class="management-section">
        <div class="section-header">
            <h2>Data Management</h2>
            <p>Clean sensor data by different scopes</p>
        </div>
        
        <div class="management-cards">
            <!-- Clean All Data -->
            <div class="management-card danger">
                <div class="card-header">
                    <h3>üóëÔ∏è Clean All Data</h3>
                    <p>Remove all sensor data from all devices</p>
                </div>
                <div class="card-content">
                    <p class="warning-text">‚ö†Ô∏è This will permanently delete ALL sensor data from the database!</p>
                    <form method="post" action="{% url 'iot:clean_device_data' %}" onsubmit="return confirm('Are you sure you want to delete ALL sensor data? This cannot be undone!');">
                        {% csrf_token %}
                        <input type="hidden" name="clean_type" value="all">
                        <button type="submit" class="btn-danger">Delete All Data</button>
                    </form>
                </div>
            </div>
            
            <!-- Clean by Device -->
            <div class="management-card">
                <div class="card-header">
                    <h3>üì± Clean by Device</h3>
                    <p>Remove data from a specific device</p>
                </div>
                <div class="card-content">
                    <form method="post" action="{% url 'iot:clean_device_data' %}" onsubmit="return confirm('Are you sure you want to delete data for this device?');">
                        {% csrf_token %}
                        <input type="hidden" name="clean_type" value="device">
                        <div class="form-group">
                            <label for="device_select">Select Device:</label>
                            <select name="target_id" id="device_select" required>
                                <option value="">Choose a device...</option>
                                {% for device in devices %}
                                <option value="{{ device.id }}">{{ device.name }} ({{ device.device_id }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn-warning">Clean Device Data</button>
                    </form>
                </div>
            </div>
            
            <!-- Clean by Group -->
            <div class="management-card">
                <div class="card-header">
                    <h3>üë• Clean by Group</h3>
                    <p>Remove data from all devices in a group</p>
                </div>
                <div class="card-content">
                    <form method="post" action="{% url 'iot:clean_device_data' %}" onsubmit="return confirm('Are you sure you want to delete data for all devices in this group?');">
                        {% csrf_token %}
                        <input type="hidden" name="clean_type" value="group">
                        <div class="form-group">
                            <label for="group_select">Select Group:</label>
                            <select name="target_id" id="group_select" required>
                                <option value="">Choose a group...</option>
                                {% for group in groups %}
                                <option value="{{ group.id }}">{{ group.name }} ({{ group.devices.count }} devices)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn-warning">Clean Group Data</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Statistics Tables -->
    <div class="stats-tables">
        <div class="stats-table-container">
            <h3>üìä Data by Device Type</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Device Type</th>
                        <th>Device Count</th>
                        <th>Data Entries</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in admin_stats.device_type_stats %}
                    <tr>
                        <td>
                            {% if stat.device_type == 'sensor' %}üå°Ô∏è Sensor
                            {% elif stat.device_type == 'thermostat' %}üå°Ô∏è Temperature Sensor
                            {% elif stat.device_type == 'light' %}üí° Light
                            {% elif stat.device_type == 'camera' %}üì∑ Camera
                            {% elif stat.device_type == 'lock' %}üîí Lock
                            {% elif stat.device_type == 'speaker' %}üîä Speaker
                            {% elif stat.device_type == 'hub' %}üè† Hub
                            {% elif stat.device_type == 'actuator' %}‚öôÔ∏è Actuator
                            {% elif stat.device_type == 'vehicle' %}üöó Vehicle
                            {% else %}üì± {{ stat.device_type|title }}
                            {% endif %}
                        </td>
                        <td>{{ stat.device_count }}</td>
                        <td>{{ stat.data_count|floatformat:0 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="stats-table-container">
            <h3>üë• Data by Group</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Group Name</th>
                        <th>Devices</th>
                        <th>Data Entries</th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in groups %}
                    <tr>
                        <td>{{ group.name }}</td>
                        <td>{{ group.devices.count }}</td>
                        <td>{{ group.devices.all|length }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <h3>Quick Actions</h3>
        <div class="action-buttons">
            <a href="{% url 'iot:registration_requests' %}" class="btn-secondary">
                üìã Registration Requests
            </a>
            <a href="{% url 'iot:create_group' %}" class="btn-secondary">
                ‚ûï Create Group
            </a>
            <a href="{% url 'iot:dashboard' %}" class="btn-secondary">
                üìä Dashboard
            </a>
            <a href="{% url 'iot:historical_data' %}" class="btn-secondary">
                üìà Historical Data
            </a>
        </div>
    </div>
</div>

<style>
.admin-dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.admin-header {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
    color: white;
    box-shadow: 0 8px 32px rgba(220, 38, 38, 0.3);
}

.admin-title {
    font-size: 2.5rem;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 16px;
}

.admin-icon {
    font-size: 2rem;
}

.admin-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 16px;
}

.stat-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #1f2937;
    margin-bottom: 4px;
}

.stat-label {
    color: #6b7280;
    font-size: 0.9rem;
    font-weight: 600;
}

.stat-sub {
    color: #9ca3af;
    font-size: 0.75rem;
    margin-top: 2px;
}

.data-stat {
    border-left: 4px solid #3b82f6;
}

.recent-data {
    border-left: 4px solid #10b981;
}

.management-section {
    background: white;
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 40px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.section-header {
    margin-bottom: 24px;
}

.section-header h2 {
    color: #1f2937;
    margin-bottom: 8px;
}

.section-header p {
    color: #6b7280;
    margin: 0;
}

.management-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
}

.management-card {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
}

.management-card.danger {
    border-color: #ef4444;
}

.card-header {
    padding: 20px;
    background: #f9fafb;
}

.management-card.danger .card-header {
    background: #fef2f2;
}

.card-header h3 {
    margin: 0 0 8px 0;
    color: #1f2937;
    font-size: 1.1rem;
}

.card-header p {
    margin: 0;
    color: #6b7280;
    font-size: 0.9rem;
}

.card-content {
    padding: 20px;
}

.warning-text {
    color: #dc2626;
    font-weight: 600;
    margin-bottom: 16px;
    padding: 12px;
    background: #fef2f2;
    border-radius: 8px;
    border: 1px solid #fecaca;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
}

.form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    background: white;
}

.btn-danger {
    background: #dc2626;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-danger:hover {
    background: #b91c1c;
}

.btn-warning {
    background: #f59e0b;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-warning:hover {
    background: #d97706;
}

.stats-tables {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 32px;
    margin-bottom: 40px;
}

.stats-table-container {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.stats-table-container h3 {
    margin-bottom: 16px;
    color: #1f2937;
}

.stats-table {
    width: 100%;
    border-collapse: collapse;
}

.stats-table th,
.stats-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
}

.stats-table th {
    background: #f9fafb;
    font-weight: 600;
    color: #374151;
}

.stats-table tr:hover {
    background: #f9fafb;
}

.quick-actions {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.quick-actions h3 {
    margin-bottom: 16px;
    color: #1f2937;
}

.action-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.btn-secondary {
    background: #6b7280;
    color: white;
    text-decoration: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    transition: background 0.2s;
}

.btn-secondary:hover {
    background: #4b5563;
    text-decoration: none;
    color: white;
}

    color: white;
}

.alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert-success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.alert-error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
}

.admin-dashboard-section {
/* Admin Dashboard Styles */
.admin-dashboard-section {
    margin: 32px 0;
}

.admin-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.admin-stat-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 16px;
}

.admin-stat-card .stat-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.admin-stat-card .stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #1f2937;
    margin-bottom: 4px;
}

.admin-stat-card .stat-label {
    color: #6b7280;
    font-size: 0.9rem;
    font-weight: 600;
}

.admin-stat-card .stat-sub {
    color: #9ca3af;
    font-size: 0.75rem;
    margin-top: 2px;
}

.admin-stat-card.data-stat {
    border-left: 4px solid #3b82f6;
}

.admin-stat-card.recent-data {
    border-left: 4px solid #10b981;
}

.admin-management-section {
    background: white;
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.section-header {
    margin-bottom: 24px;
}

.section-header h3 {
    color: #1f2937;
    margin-bottom: 8px;
    font-size: 1.25rem;
    font-weight: 600;
}

.section-header p {
    color: #6b7280;
    margin: 0;
}

.admin-management-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
}

.admin-management-card {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
}

.admin-management-card.danger {
    border-color: #ef4444;
}

.card-header {
    padding: 20px;
    background: #f9fafb;
}

.admin-management-card.danger .card-header {
    background: #fef2f2;
}

.card-header h4 {
    margin: 0 0 8px 0;
    color: #1f2937;
    font-size: 1.1rem;
}

.card-header p {
    margin: 0;
    color: #6b7280;
    font-size: 0.9rem;
}

.card-content {
    padding: 20px;
}

.warning-text {
    color: #dc2626;
    font-weight: 600;
    margin-bottom: 16px;
    padding: 12px;
    background: #fef2f2;
    border-radius: 8px;
    border: 1px solid #fecaca;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
}

.form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    background: white;
}

.btn-danger {
    background: #dc2626;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-danger:hover {
    background: #b91c1c;
}

.btn-warning {
    background: #f59e0b;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-warning:hover {
    background: #d97706;
}

@media (max-width: 768px) {
    .admin-stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
    }
    
    .admin-management-cards {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function updateAdminStats() {
    fetch('{% url "myapp:admin_stats_api" %}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error fetching stats:', data.error);
                return;
            }
            
            // Update statistics cards
            document.querySelector('[data-stat="devices"] .stat-number').textContent = data.total_devices;
            document.querySelector('[data-stat="groups"] .stat-number').textContent = data.total_groups;
            document.querySelector('[data-stat="users"] .stat-number').textContent = data.total_users;
            document.querySelector('[data-stat="data-entries"] .stat-number').textContent = data.total_data_entries;
            document.querySelector('[data-stat="recent-entries"] .stat-number').textContent = data.recent_entries;
            
            // Update data size
            document.querySelector('[data-stat="data-entries"] .stat-sub').textContent = '~' + data.data_size_kb.toFixed(1) + ' KB';
            
            // Update timestamp
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            console.log('Stats updated at', timeString);
        })
        .catch(error => {
            console.error('Error fetching admin stats:', error);
        });
}

// Update stats every 30 seconds
{% if user.is_superuser %}
setInterval(updateAdminStats, 30000);
{% endif %}
</script>
{% endblock %}